# Tianyu Virtual Machine Gen.1
天宇虚拟机（第一代）   
----------
&emsp;  

&emsp;天宇虚拟机（第一代）包含虚拟机程序与编译器程序。  
## **虚拟机**
&emsp;  天宇虚拟机采用模拟硬件运行的方式实现，通过解析函数指令进行执行。函数指令与<u>***C语言***</u>调用函数相同，主要包括：<kbd>函数名</kbd>+<kbd>函数边界</kbd>+<kbd>参数</kbd>+<kbd>结束符</kbd>组成，其样式为：`function(prama1,prama2,...);`。  
&emsp;  函数名为指令，分为<kbd>内存</kbd>、<kbd>设备</kbd>、<kbd>网络</kbd>、<kbd>硬盘</kbd>、<kbd>程序</kbd>、<kbd>输入输出</kbd>和<kbd>运算</kbd>模块，支持中英文两种指令类型。  
&emsp;  在编写指令参数时，包含***设定关键字***、***表达式***和***其他文本类型***三种。**其他文本类型**主要用于在提供路径、IP地址等情况下需要；**设定关键字**用于为程序提供部分固定的常用表示方法，并用于当前<u>已经预设的设备</u>；**表达式**是整数型的表达式，使用<kbd>{}</kbd>进行包围，可使用<kbd>+</kbd>、<kbd>-</kbd>、<kbd>\*</kbd>、<kbd>/</kbd>和<kbd>^</kbd>。其运算符的优先级与日常的四则运算相同，<kbd>^</kbd>><kbd>*,/</kbd>><kbd>+,-</kbd>，可以使用<kbd>()</kbd>改变其运算顺序。  
&emsp;  因为本虚拟机需要操作内存，所以在表达式中引入<kbd>[]</kbd>用于获取当前内存块的数据，以提供多级寻址的能力。  
&emsp;  除了指令系统，天宇虚拟机还提供了**中断**功能，用于为<kbd>设备</kbd>和<kbd>IO系统</kbd>提供及时的数据相应，在当前的系统中，提供了针对常用异常和调用的中断。

&emsp;  下面将针对具体的指令系统和中断系统进行说明。
&emsp;  

#### **指令系统**
+ 内存模块访问指令  

|中文指令|英文指令|参数列表|说明|  
|:------:|:-------:|:----:|:------|
|设定内存|set|内存空间大小|用于设置程序的初始化大小|
|申请内存|new|内存块表达式|用于申请信的空闲空间
|       |   |空间大小   ||
|释放内存|free|内存块表达式|用于释放手动申请的空间|
|初始内存|minit|内存块表达式|用于初始化、批量初始化连续的内存空间|
|       |       |操作数类型||
|       |       |立即数|    |
|       |       |重复次数|  |
|获取时间|tread|内存块表达式|用于获取指定的时间放入到指定的内存区块|
|       |       |时间类型|  |
|写入时间|twrite|内存块表达式|用于写入指定的时间|
|       |       |时间类型|  |
|时间同步|tsync|-|用于同步时间|

&emsp;  

+ 设备模块指令

|中文指令|英文指令|参数列表|说明|  
|:------:|:-------:|:----:|:------|
|激活设备|dact|设备中断号|用于激活指定设备，使设备进入运行状态|
|暂停设备|dpause|设备中断号|用于暂停设备，使设备进入暂停状态|
|复位设备|dreset|设备中断号|用于设置设备回复初始化|
|关闭设备|dclose|设备中断号|用于关闭设备，使设备离线|
|读设备|dread|设备中断号|用于从设备基础缓冲区中将数据读入新建的内存中|
|||内存块表达式||
|写设备|dwrite|设备中断号|将数据从指定的内存中写入到指定的设备，|
|||内存块表达式|并触发指定设备的中断服务程序|
|||数据长度||

&emsp; 

+ 网络模块

|中文指令|英文指令|参数列表|说明|  
|:------:|:-------:|:----:|:------|
|新建连接|connect|网络连接编号|用于新建一个网络连接|
|||IP地址||
|||IP端口号||
|||IP地址类型||
|||网络协议||
|||网络连接类型||
|暂停连接|npause|网络连接编号|用于暂停一个网络连接|
|恢复连接|nreset|网络连接编号|用于将一个网络连接从暂停中恢复|
|结束连接|stop|网络连接编号|用于将网络连接终止并释放其占用的资源|
|获取端口|getport|网络连接编号|获取指定网络连接的服务器/客户端IP地址端口|
|||端口类型||
|||内存块表达式||
|发送数据|send|网络连接编号|用于将内存中的指定数据发送到指定连接上|
|||内存块表达式||
|||数据长度||
|接受数据|receive|网络连接编号|从指定连接中获取接收到的数据|
|||内存块表达式||

&emsp; 

+ 硬盘模块

|中文指令|英文指令|参数列表|说明|  
|:------:|:-------:|:----:|:------|  
|新建|create|路径|在硬盘中创建指定的目录/文件|  
|||文件类型||
|删除|delete|路径|从硬盘中删除指定的目录/文件|
|||文件类型||
|打开文件|fopen|文件标志编号|打开指定文件|
|||文件路径||
|||写入方式||
|关闭文件|fclose|文件标志编号|关闭打开的文件|
|文件指向|position|文件标志编号|修改文件访问位置|
|||光标指向位置||
|读文件|fread|文件标志编号|用于将文件中的部分数据读入指定的内存|
|||内存块表达式||
|||读取文件长度||
|写文件|fwrite|文件标志编号|用于将指定内存块中的数据写入文件|
|||内存块表达式||
|||数据长度||
|拷贝文件|fcopy|源文件路径|用于拷贝指定文件|
|||目标文件路径||

&emsp; 
+ 程序模块

|中文指令|英文指令|参数列表|说明|  
|:------:|:-------:|:----:|:------|
|本地结束|end|-|用于程序最后一条指令结束后的自动处理|
|启动进程|pinit|文件路径|用于打开文件并创建新进程后执行|
|结束进程|pend|-|结束正在执行的进程|
|切换进程|pswitch|-|用于暂停当前进程并进入下一个进程|
|加载文件|tinit|加载文件标识|用于打开文件并将代码加载至指令空间|
|||文件路径||
|结束加载|tend|加载文件标识|从指令空间中移除指定的代码|
|外部调用|callo|加载文件标识|用于指示程序进入一个新的代码空间中|
|||标识符||
|本地调用|call|标识符|指示程序进入新的过程，并保存当前的执行位置|
|结束调用|ret|-|结束当前过程，并返回上一个过程|
|跳转|jmp|标识符|无条件转移指令，进入新过程，但不保存当前执行位置|
|正跳转|jns|标识符|当运算标识符为正时转移到新的过程，不保存当前执行位置|
|负跳转|js|标识符|当运算标识符为负时转移到新的过程，不保存当前执行位置|
|零跳转|jz|标识符|当运算标识符为零时转移到新的过程，不保存当前执行位置|
|入栈|push|内存块表达式|将指定数据送入公共数据堆栈|
|出栈|pop|内存块表达式|将公共数据堆栈栈顶返回到指定的内存中|

*注：当前实例程序尚未加入对多线程、多进程的支持，故线程、进程操作指令无效*  

&emsp; 
+ 输入输出模块

|中文指令|英文指令|参数列表|说明|  
|:------:|:-------:|:----:|:------|
|显示输出|print|内存块表达式|用于将指定的内存数据显示在控制台中，采用系统默认编码|
|||数据长度||
||print|字符串|将字符串输出在控制台中|
|显示字符|putc|内存块表达式|将指定内存的字符显示在控制台中|
|键盘输入|scan|内存块表达式|从键盘缓冲区中输入指定长度的数据到内存（内存需要自行申请）|
|||数据长度||

&emsp; 
+ 运算模块

|中文指令|英文指令|参数列表|说明|  
|:------:|:-------:|:----:|:------|
|加法|add|操作数类型|用于将后两个内存块中的指定大小数据相加后保存在第一个内存块|
|||内存块表达式||
|||内存块表达式||
|||内存块表达式||
|减法|sub|操作数类型|用于将后两个内存块中的指定大小数据相减后保存在第一个内存块|
|||内存块表达式||
|||内存块表达式||
|||内存块表达式||
|乘法|mul|操作数类型|用于将后两个内存块中的指定大小数据相乘后保存在第一个内存块|
|||内存块表达式||
|||内存块表达式||
|||内存块表达式||
|除法|div|操作数类型|用于将后两个内存块中的指定大小数据相除后的商保存在第一个内存块|
|||内存块表达式||
|||内存块表达式||
|||内存块表达式||
|求余|mod|操作数类型|用于将后两个内存块中的指定大小数据求余后的余数保存在第一个内存块|
|||内存块表达式||
|||内存块表达式||
|||内存块表达式||
|逻辑与|and|操作数类型|用于将后两个内存块中的指定大小数据按位相与后保存在第一个内存块|
|||内存块表达式||
|||内存块表达式||
|||内存块表达式||
|逻辑或|or|操作数类型|用于将后两个内存块中的指定大小数据按位或后保存在第一个内存块|
|||内存块表达式||
|||内存块表达式||
|||内存块表达式||
|逻辑异或|xor|操作数类型|用于将后两个内存块中的指定大小数据按位异或后保存在第一个内存块|
|||内存块表达式||
|||内存块表达式||
|||内存块表达式||
|逻辑非|not|操作数类型|用于将内存块中的数据按位取反后保存在原内存块|
|||内存块表达式||
|随机数|rand|内存块表达式|用于生成一个32位的指定范围的随机数并保存在指定的内存块|
|||起始值||
|||结束值||

&emsp; 


#### **已定义的关键字**

|关键字名|助记符|所属标签|说明|  
|:------:|:-------:|:----:|:------|
|操作数类型|\[数字\]|操作数类型|操作数类型为1、2、4、8|
|4代IP|IPv4|IP地址类型|IP地址长度为32位|
|6代IP|IPv6||IP地址长度为128位|
|TCP协议|TCP/IP|协议类型|可靠的传输服务协议|
|UDP协议|UDP||不可靠的传输服务协议|
|服务器|Server|连接模式|只用于接收数据的连接|
|客户端|Client||只用于发送数据的连接|
|混合模式|Mix||可用于发送与接收数据的连接|
|接收端口|Server|端口类型|用于接收数据的端口|
|发送端口|Client||用于发送数据的端口|
|自动端口|Auto||自动的端口类型，默认为服务器端口，无服务器时为客户端端口|
|目录|Entry|路径类型|指定路径为目录|
|文件|File||指定路径为文件|
|追加写入|append|文件写入方式|将数据写入到文件的末尾|
|覆盖写入|cover||从文件指针开始处写入数据并覆盖掉原有数据|
|新建写入|create||创建新文件并从头写入，如果文件存在则删除|
|设备正常|DS_OK|设备运行状态||
|设备暂停|DS_PU|||
|设备异常|DS_ER|||
|时间年|Year|时间操作类型||
|时间月|Month|||
|时间日|Day|||
|时间小时|Hour|||
|时间分|Minute|||
|时间秒|Second|||

&emsp; 

#### **异常中断表**
&emsp;  异常中断是用于程序内部的调用指令，包括错误中断以及系统调用中断，具体的中断如下表所示。其他未显示的中断号为未分配中断，后期的开发中可以进行扩充。  

|关键字名|助记符|  
|:------:|:-------|
|0x00|数学异常-除零中断|
|0x01|数学异常-计算溢出|
|||
|0x10|数据异常-数组越界|
|0x11|数据异常-空地址|
|0x12|缺页中断|
|0x13|内存申请中断|
|0x14|内存释放中断|
|0x15|获取时间中断|
|0x16|修改时间中断|
|0x17|同步时间中断|
|0x18|系统异常-堆栈溢出|
|0x19|系统异常-堆栈越界|
|0x1A|系统异常-内存溢出|
|||
|0x20|进程切换|
|0x21|进程结束|
|0x22|结束正在执行的线程（文件）并回退|
|0x23|加载进程|
|0x24|载入线程|
|||
|0x30|键盘输入|
|0x31|显示输出|
|0x33|数据源空|
|||
|0x40|创建网络连接|
|0x41|发送数据|
|0x42|接收数据|
|0x43|获取网络端口号|
|0x45|暂停网络连接|
|0x46|复位网络连接|
|0x47|关闭网络连接|
|||
|0x50|设备中断-激活设备|
|0x51|设备中断-暂停设备|
|0x52|设备中断-复位设备|
|0x53|设备中断-关闭设备|
|0x54|设备中断-读设备|
|0x55|设备中断-写设备|
|||
|0x60|打开文件|
|0x61|关闭文件|
|0x62|读文件|
|0x63|写文件|
|0x64|拷贝文件|
|0x65|移动指针|
|0x67|创建文件|
|0x68|删除文件|
|||
|0xE0|核心中断-设置时间片|
|0xE1|核心中断-获取时间片|
|0xE2|核心中断-获取核心数|

&emsp;  
&emsp;  注：部分多线程、多进程相关的中断当前只进行了定义，未进行具体的实现，因此暂时不可使用。部分异常在当前的设置环境中还未被使用。

&emsp;  

## **编译器**
### **PL/0语法**

### **词法符号**

### **语法分析过程**

## **使用说明**
### **编译器**
+ Compiler.exe

&emsp;  

+ PL0_Comletion.DLL

### **虚拟机**